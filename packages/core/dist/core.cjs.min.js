"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=Object.prototype.toString;function e(e,n){return t.call(e)===`[object ${n}]`}function n(t){return null!==t&&e(t,"Object")}function r(t){return function(t){return t&&Array.isArray(t)}(t)||function(t){return e(t,"String")}(t)?0===t.length:t instanceof Map||t instanceof Set?0===t.size:!!n(t)&&0===Object.keys(t).length}function s(t){return"function"==typeof t}function i(t){return"undefined"!=typeof window&&e(t,"Window")}const o="undefined"!=typeof process,a=n("undefined"!=typeof wx?wx:0)&&s("undefined"!=typeof App?App:0);function c(t,e){const n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[];let s;if(e=e||n.length,t)for(s=0;s<t;s++)r[s]=n[0|Math.random()*e];else{let t;for(r[8]="-",r[13]="-",r[18]="-",r[23]="-",r[14]="4",s=0;s<36;s++)r[s]||(t=0|16*Math.random(),r[s]=n[19==s?3&t|8:t])}return r.join("")}class u{constructor(){this.stack=[]}get_cache(){return t=this.stack,JSON.parse(JSON.stringify(t));var t}add_cache(t){this.stack.push(t)}clear_cache(){this.stack=[]}}i?window:a?wx:o&&process;class h{constructor(){this.cache=new Map}watch(t,e){const n=this.cache.get(t);n?this.cache.set(t,n.concat(e)):this.cache.set(t,[e])}notify(t,e){const n=this.cache.get(t);t&&n&&n.forEach((n=>{!function(t,e){try{t()}catch(t){e?e(t):console.error("err",t)}}((()=>{n(e)}),(e=>{console.error(`Subscribe.notify: 监听事件的回调函数发生错误\n\n                        eventName:${t}\n\n                        Name: ${function(t){return t&&"function"==typeof t&&t.name||"<anonymous>"}(n)}\n\n                        Error: ${e}`)}))}))}}function p(t,e,n,r){return new(n||(n=Promise))((function(s,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}exports.BaseClient=class{constructor(t){this.options=t}use(t){const e=new h;t.forEach((t=>{if(!this.isPluginsEnable(t.type))return;if(!this.isPluginEnable(t.name))return;t.monitor.call(this,e.notify.bind(e));e.watch(t.name,((...e)=>{var n,r;const s=null===(n=t.transform)||void 0===n?void 0:n.apply(this,e);null===(r=t.consumer)||void 0===r||r.call(this,s)}))}))}getOptions(){return this.options}log(t,e=!1){const n=Object.assign({},t);var r;n.startTime=Date.now(),n.pageURL||(n.pageURL="undefined"==typeof document||null==document.location?"":null===(r=document.location.href)||void 0===r?void 0:r.split("?")[0]),this.report.send(t,e)}},exports.BaseOptions=class{constructor(){this.beforeAppAjaxSend=null,this.vue=null,this.sample=100}bindOptions(t){t.sample&&(this.sample=t.sample),t.vue&&Object.keys(t.vue).length>0&&(this.vue=t.vue),t.beforeAppAjaxSend&&s(t.beforeAppAjaxSend)&&(this.beforeAppAjaxSend=t.beforeAppAjaxSend)}},exports.BaseReport=class{constructor(){this.url="",this.appID="",this.userID="",this.appName="",this.cacheNum=50,this.beforeDataReport=null,this.timer=null,this.queue=new u,this.submitErrorUids=[]}bindOptions(t){this.appID=t.appID,this.url=t.url,t.appName&&(this.appName=t.appName),t.cacheNum&&(this.cacheNum=t.cacheNum),t.userID?this.userID=t.userID:this.userID=function(){let t="";return i?(t=localStorage.getItem("uuid"),t||(t=c(16),localStorage.setItem("uuid",t),t)):a?(t=wx.getStorageSync("uuid"),t||(t=c(16),wx.setStorageSync("uuid",t),t)):void 0}()}send(t,e=!1){return p(this,void 0,void 0,(function*(){if(t.extraData&&t.extraData.errorUid){if(this.submitErrorUids.indexOf(t.extraData.errorUid)>-1)return;this.submitErrorUids.push(t.extraData.errorUid)}let n=Object.assign({},this.formatReportData(t));if(n=Object.assign({},this.getReportData(n)),!s(this.beforeDataReport)||(n=yield this.beforeDataReport(n),n)){if(!r(this.url))return this.sendTime(n,this.url,e);console.error("请设置上传 URL 地址")}}))}formatReportData(t){return{id:c(16),appID:this.appID,userID:this.userID,appName:this.appName,data:t}}sendTime(t,e,n){n?this.report(t,e):(this.queue.add_cache(t),clearTimeout(this.timer),this.timer=setTimeout((()=>{const t=this.queue.get_cache();t&&t.length>=this.cacheNum&&(this.report(t,e),this.queue.clear_cache())}),3e3))}};
