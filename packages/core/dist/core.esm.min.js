import{native_try_catch as t,get_function_name as e,get_page_url as s,Queue as i,get_uuid as r,get_unique_id as a,isFunction as n,isEmpty as o}from"@qmonitor/utils";class h{constructor(){this.cache=new Map}watch(t,e){const s=this.cache.get(t);s?this.cache.set(t,s.concat(e)):this.cache.set(t,[e])}notify(s,i){const r=this.cache.get(s);s&&r&&r.forEach((r=>{t((()=>{r(i)}),(t=>{console.error(`Subscribe.notify: 监听事件的回调函数发生错误\n\n                        eventName:${s}\n\n                        Name: ${e(r)}\n\n                        Error: ${t}`)}))}))}}class c{constructor(t){this.options=t}use(t){const e=new h;t.forEach((t=>{if(!this.isPluginsEnable(t.type))return;if(!this.isPluginEnable(t.name))return;t.monitor.call(this,e.notify.bind(e));e.watch(t.name,((...e)=>{var s,i;const r=null===(s=t.transform)||void 0===s?void 0:s.apply(this,e);null===(i=t.consumer)||void 0===i||i.call(this,r)}))}))}getOptions(){return this.options}log(t,e=!1){const i=Object.assign({},t);i.startTime=Date.now(),i.pageURL||(i.pageURL=s()),this.report.send(t,e)}}function u(t,e,s,i){return new(s||(s=Promise))((function(r,a){function n(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,o)}h((i=i.apply(t,e||[])).next())}))}class p{constructor(){this.url="",this.appID="",this.userID="",this.appName="",this.cacheNum=50,this.beforeDataReport=null,this.timer=null,this.queue=new i,this.submitErrorUids=[]}bindOptions(t){this.appID=t.appID,this.url=t.url,t.appName&&(this.appName=t.appName),t.cacheNum&&(this.cacheNum=t.cacheNum),t.userID?this.userID=t.userID:this.userID=r()}send(t,e=!1){return u(this,void 0,void 0,(function*(){if(t.extraData&&t.extraData.errorUid){if(this.submitErrorUids.indexOf(t.extraData.errorUid)>-1)return;this.submitErrorUids.push(t.extraData.errorUid)}let s=Object.assign({},this.formatReportData(t));if(s=Object.assign({},this.getReportData(s)),!n(this.beforeDataReport)||(s=yield this.beforeDataReport(s),s)){if(!o(this.url))return this.sendTime(s,this.url,e);console.error("请设置上传 URL 地址")}}))}formatReportData(t){return{id:a(16),appID:this.appID,userID:this.userID,appName:this.appName,data:t}}sendTime(t,e,s){s?this.report(t,e):(this.queue.add_cache(t),clearTimeout(this.timer),this.timer=setTimeout((()=>{const t=this.queue.get_cache();t&&t.length>=this.cacheNum&&(this.report(t,e),this.queue.clear_cache())}),3e3))}}class l{constructor(){this.beforeAppAjaxSend=null,this.vue=null,this.sample=100}bindOptions(t){t.sample&&(this.sample=t.sample),t.vue&&Object.keys(t.vue).length>0&&(this.vue=t.vue),t.beforeAppAjaxSend&&n(t.beforeAppAjaxSend)&&(this.beforeAppAjaxSend=t.beforeAppAjaxSend)}}export{c as BaseClient,l as BaseOptions,p as BaseReport};
