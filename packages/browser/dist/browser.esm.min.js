import{BaseOptions as e,BaseReport as t,BaseClient as r}from"@qmonitor/core";import{isFunction as n,_global as o,safe_stringify as s,format_string as a,first_str_to_uppercase as i,get_page_url as c,get_error_uid as d,on as p,parse_stack_frames as u,off as l,is_support_performance_observer as m,on_hidden as f,deep_copy as h,_supportPerformance as g,on_load as b,sampling as y,on_beforeunload as v}from"@qmonitor/utils";class T extends e{constructor(e){super(),this.configReportXhr=null,super.bindOptions(e),this.bindOptions(e)}bindOptions(e){const{disabledPerformance:t,disabledBehavior:r,disabledError:o,disabledCustom:s,disabledConsoleError:a,disabledJsError:i,disabledPromiseError:c,disabledResourceError:d,disabledFirstPaint:p,disabledFirstContentfulPaint:u,disabledLargestContentfulPaint:l,disabledFirstInputDelay:m,disabledCumulativeLayoutShift:f,disabledNavigation:h,disabledResource:g,disabledXhr:b,disabledFetch:y,disabledFirstMeaningPaint:v,useImgUpload:T,configReportXhr:S}=e;this.disabledPerformance=t||!1,this.disabledBehavior=r||!1,this.disabledError=o||!1,this.disabledCustom=s||!1,this.disabledXhr=b||!1,this.disabledFetch=y||!1,this.disabledFirstMeaningPaint=v||!1,this.disabledConsoleError=a||!1,this.disabledJsError=i||!1,this.disabledPromiseError=c||!1,this.disabledResourceError=d||!1,this.disabledFirstPaint=p||!1,this.disabledFirstContentfulPaint=u||!1,this.disabledLargestContentfulPaint=l||!1,this.disabledFirstInputDelay=m||!1,this.disabledCumulativeLayoutShift=f||!1,this.disabledNavigation=h||!1,this.disabledResource=g||!1,this.useImgUpload=T||!1,S&&n(S)&&(this.configReportXhr=S)}}function S(e,t,r,n){return new(r||(r=Promise))((function(o,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function i(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,i)}c((n=n.apply(e,t||[])).next())}))}function w(){if(window.navigator.connection){const e=window.navigator.connection;return{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}}return null}class R extends t{constructor(e){super(),this.configReportXhr=null,this.useImgUpload=!1,super.bindOptions(e),this.bindOptions(e)}post(e,t){const r=new XMLHttpRequest;r.open("post",t),r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.withCredentials=!0,this.configReportXhr&&n(this.configReportXhr)&&this.configReportXhr(r,e),r.send(s(e))}imgRequest(e,t){let r=new Image;const n=-1===t.indexOf("?")?"?":"&";r.src=`${t}${n}data=${encodeURIComponent(s(e))}`,r=null}beaconPost(e,t){o.navigator.sendBeacon.call(window.navigator,t,s(e))}report(e,t){let r=null;r=this.useImgUpload?this.imgRequest:o.navigator&&o.navigator.sendBeacon?this.beaconPost:this.post,o.requestIdleCallback?o.requestIdleCallback((()=>S(this,void 0,void 0,(function*(){yield r(e,t)})))):setTimeout((()=>S(this,void 0,void 0,(function*(){yield r(e,t)}))))}getReportData(e){return Object.assign(Object.assign({},e),{networkInfo:w()})}bindOptions(e){this.useImgUpload=e.useImgUpload||!1,e.configReportXhr&&n(e.configReportXhr)&&(this.configReportXhr=e.configReportXhr)}}class E extends r{constructor(e){super(e),this.options=new T(e),this.report=new R(e)}isPluginEnable(e){const t=`disabled${a(e)}`;return!this.options[t]}isPluginsEnable(e){const t=`disabled${i(e)}`;return!this.options[t]}}const x={name:"console-error",type:"error",monitor(e){o.console.error=(...t)=>{e("console-error",t)}},transform:e=>({type:"error",subType:"console-error",pageURL:c(),extraData:{type:"",errorUid:d(`console-error-${e[0]}`),msg:e.join(";"),meta:void 0,stackTrace:void 0}}),consumer(e){this.report.send(e,!0)}},D={name:"js-error",type:"error",monitor(e){p(o,"error",(t=>{t.target.localName||(t.preventDefault(),e("js-error",t))}),!0)},transform:e=>function(e){return{type:"error",subType:"js-error",pageURL:c(),extraData:{type:e.error&&e.error.name||"UnKnown",errorUid:d(`js-error-${e.message}-${e.filename}`),msg:e.stack||e.message,meta:{file:e.filename,col:e.colno,row:e.lineno},stackTrace:{frames:u(e.error)}}}}(e),consumer(e){this.report.send(e,!0)}},L={name:"resource-error",type:"error",monitor(e){p(o,"error",(t=>{t.target.localName&&(t.preventDefault(),e("resource-error",t))}),!0)},transform:e=>function(e){const t=e.src||e.href;return{type:"error",subType:"resource-error",pageURL:c(),extraData:{type:"resource-error",errorUid:d(`resource-error-${e.src}-${e.tagName}`),msg:"资源地址: "+t,meta:{url:t,html:e.outerHTML,type:e.tagName},stackTrace:void 0}}}(e.target),consumer(e){this.report.send(e,!0)}};const U={name:"promise-error",type:"error",monitor(e){p(o,"unhandledrejection",(t=>{e("promise-error",t)}))},transform(e){const t=e.reason.stack||e.reason.message||e.reason,r=e.reason.name||"UnKnown";return{type:"error",subType:"promise-error",pageURL:c(),extraData:{type:r,errorUid:d(`promise-error-${t}`),msg:t,meta:void 0,stackTrace:{frames:u(e.reason)}}}},consumer(e){this.report.send(e,!0)}},O={name:"fetch",type:"performance",monitor(e){P.call(this,e)},transform:e=>e,consumer(e){this.report.send(e)}},C=o.fetch;function P(e){const{options:t}=this;"fetch"in o&&(o.fetch=(r,n={})=>{const o=Date.now(),s=(n&&n.method||"GET").toUpperCase(),a={type:"performance",subType:"fetch",pageURL:c(),extraData:{startTime:o,url:r,method:s,data:n.body}},i=new Headers(n.headers||{});return Object.assign(i,{setRequestHeader:i.set}),t.beforeAppAjaxSend&&t.beforeAppAjaxSend({url:r,method:s},i),C(r,n).then((t=>{const r=t.clone(),n=Date.now();return a.extraData=Object.assign(Object.assign({},a.extraData),{endTime:n,duration:n-a.extraData.startTime,status:r.status,success:r.ok}),r.text().then((()=>{e("fetch",a)})),t})).catch((t=>{const r=Date.now();throw a.extraData=Object.assign(Object.assign({},a.extraData),{endTime:r,duration:r-a.extraData.startTime,status:0,success:!1}),e("fetch",a),t}))})}const j={name:"xhr",type:"performance",monitor(e){k.call(this,e)},transform:e=>e,consumer(e){this.report.send(e)}};function k(e){const{options:t}=this;if(!("XMLHttpRequest"in o))return;const r=XMLHttpRequest.prototype,n=r.open,s=r.send;r.open=function(...e){var t,r;this.url=null===(r=null===(t=e[1])||void 0===t?void 0:t.split("?"))||void 0===r?void 0:r[0],this.method=e[0],n.apply(this,e)},r.send=function(...r){this.startTime=Date.now(),t.beforeAppAjaxSend&&t.beforeAppAjaxSend({method:this.method,url:this.url},this);const n=()=>{this.endTime=Date.now(),this.duration=this.endTime-this.startTime;const{status:t,duration:r,startTime:o,endTime:s,url:a,method:i}=this,d={type:"performance",subType:"xhr",extraData:{status:t,duration:r,startTime:o,endTime:s,url:a,method:(i||"GET").toUpperCase(),success:t>=200&&t<300},pageURL:c()};e("xhr",d),l(this,"loadend",n,!0)};p(this,"loadend",n,!0),s.apply(this,r)}}const q={name:"cumulative-layout-shift",type:"performance",monitor(e){if(!m())return;let t=0,r=[];const n={type:"performance",subType:"cumulative-layout-shift",pageURL:"",extraData:{value:0}};function s(o){n.pageURL=c();for(const s of o.getEntries()){const o=s;if(!o.hadRecentInput){const a=r[0],i=r[r.length-1];t&&s.startTime-i.startTime<1e3&&s.startTime-a.startTime<5e3?(t+=o.value,r.push(I(s))):(t=o.value,r=[I(s)]),t>n.extraData.value&&(n.extraData={entry:o,value:t,entries:r},e("cumulative-layout-shift",h(n)))}}}const a=new PerformanceObserver(s);a.observe({type:"layout-shift",buffered:!0}),a&&f(o,(()=>{a.takeRecords().map(s)}))},transform:e=>e,consumer(e){this.report.send(e)}};function I(e){const t=e.toJSON();return delete t.duration,delete t.sources,t}const X={name:"first-input-delay",type:"performance",monitor(e){if(!g)return;const t=new PerformanceObserver((function(r){t&&t.disconnect();for(const t of r.getEntries()){const r={type:"performance",subType:"first-input-delay",pageURL:c(),extraData:Object.assign({},t.toJSON())};e("first-input-delay",r)}}));t.observe({type:"first-input",buffered:!0})},transform:e=>e,consumer(e){this.report.send(e)}};let N=!1;const B={name:"largest-contentful-paint",type:"performance",monitor(e){if(!g)return void(N=!0);const t=new PerformanceObserver((function(r){N=!0,t&&t.disconnect();for(const t of r.getEntries()){const r={type:"performance",subType:"largest-contentful-paint",pageURL:c(),extraData:Object.assign({},t.toJSON())};e("largest-contentful-paint",r)}}));t.observe({type:"largest-contentful-paint",buffered:!0})},transform:e=>e,consumer(e){this.report.send(e)}};let A,F=!1;b(o,(()=>{F=!0}));const z=[],$={name:"first-meaning-paint",type:"performance",monitor(e){if(!MutationObserver)return;const t=window.requestAnimationFrame?requestAnimationFrame:setTimeout,r=["STYLE","SCRIPT","LINK","META"];A=new MutationObserver((n=>{M(e);const o={startTime:0,children:[]};t((()=>{o.startTime=performance.now()}));for(const e of n)if(e.addedNodes.length)for(const t of[...e.addedNodes])1!==t.nodeType||r.includes(t.tagName)||G(t,o.children)||o.children.push(t);o.children.length&&z.push(o)})),A.observe(document,{childList:!0,subtree:!0})},transform:e=>e,consumer(e){this.report.send(e)}};let H=null;function M(e){clearTimeout(H),H=setTimeout((()=>{if(N&&F){A&&A.disconnect();const t={type:"performance",subType:"first-meaning-paint",pageURL:c(),extraData:{startTime:J()}};e("first-meaning-paint",t)}else M(e)}),500)}function J(){let e=0;return z.forEach((t=>{for(const r of t.children)if(K(r)&&t.startTime>e&&_(r)){e=t.startTime;break}})),performance.getEntriesByType("resource").forEach((t=>{"img"===t.initiatorType&&t.fetchStart<e&&t.responseEnd>e&&(e=t.responseEnd)})),e}function G(e,t){return!(!e||e===document.documentElement)&&(!!t.includes(e)||G(e.parentElement,t))}function K(e){const t=window.innerWidth,r=window.innerHeight,n=e.getBoundingClientRect();return n.left>=0&&n.left<t&&n.top>=0&&n.top<r}function _(e){return"none"!==window.getComputedStyle(e).display&&!("IMG"===e.tagName&&e.width<2&&e.height<2)}const W={name:"first-paint",type:"performance",monitor(e){if(!g)return;const t=new PerformanceObserver((function(r){for(const n of r.getEntries()){"first-contentful-paint"===n.name&&t.disconnect();const r={type:"performance",subType:n.name,pageURL:c(),extraData:Object.assign({},n.toJSON())};e("first-paint",r)}}));t.observe({type:"paint",buffered:!0})},transform:e=>e,consumer(e){this.report.send(e)}},Y={name:"resource",type:"performance",monitor(e){g&&b(o,(()=>Z.call(this,"resource",e)))},transform(e){const t={type:"performance",subType:"resource",extraData:{},pageURL:""};return t.extraData={name:e.name.split("/")[e.name.split("/").length-1],sourceType:e.initiatorType,ttfb:e.responseStart,transferSize:e.transferSize,protocol:e.nextHopProtocol,encodedBodySize:e.encodedBodySize,decodedBodySize:e.decodedBodySize,resourceRatio:e.decodedBodySize/e.encodedBodySize||1,isCache:te(e),startTime:performance.now(),redirect:e.redirectEnd-e.redirectStart,dns:e.domainLookupEnd-e.domainLookupStart,tcp:e.connectEnd-e.connectStart,request:e.responseStart-e.requestStart,response:e.responseEnd-e.responseStart,duration:e.duration},t},consumer(e){this.report.send(e)}},Q={name:"navigation",type:"performance",monitor(e){g&&b(o,(()=>Z.call(this,"navigation",e)))},transform(e){const t={type:"performance",subType:"navigation",extraData:{},pageURL:""};return t.pageURL=c(),t.extraData={fp:e.responseEnd-e.fetchStart,tti:e.domInteractive-e.fetchStart,domReady:e.domContentLoadedEventEnd-e.fetchStart,load:e.loadEventStart-e.fetchStart,firstByte:e.responseStart-e.domainLookupStart,dns:e.domainLookupEnd-e.domainLookupStart,tcp:e.connectEnd-e.connectStart,ssl:e.secureConnectionStart?e.connectEnd-e.secureConnectionStart:0,ttfb:e.responseStart-e.requestStart,trans:e.responseEnd-e.responseStart,domParse:e.domInteractive-e.responseEnd,res:e.loadEventStart-e.domContentLoadedEventEnd},t},consumer(e){this.report.send(e)}};let V=!1;function Z(e,t){const r=new PerformanceObserver((function(n){for(const s of n.getEntries()){const n=s;if("navigation"===e){if(V)return;r&&r.disconnect(),V=!0}if(!n.nextHopProtocol&&"navigation"!==e||(o=n.initiatorType,ee.includes(o)))return;t(e,n)}var o}));r.observe({type:e,buffered:!0})}const ee=["fetch","xmlhttprequest","beacon"];function te(e){return 0===e.transferSize||0!==e.transferSize&&0===e.encodedBodySize}/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&ee.push("other");const re=function(e={},t=[]){const r=new E(e),n=r.getOptions().sample;let s=[x,D,L,U];if(y(n)){s=[...s,j,O,q,X,$,W,B,Y,Q];v(o,(()=>{const e=r.report.queue.get_cache();e&&e.length>0&&(r.report.post(e,r.report.url),r.report.queue.clear_cache())}))}return r.use([...s,...t]),r};export{E as BrowserClient,re as init};
