# Quantum Monitor 项目总体架构

## 项目概述

Quantum Monitor 是一款前端监控与统计SDK，采用monorepo架构，支持多端（浏览器、微信小程序）的监控需求。

## 功能特性

- **性能监控**：FP、FCP、FMP、LCP、FID、CLS、资源加载性能
- **错误监控**：JS错误、资源错误、Promise错误、控制台错误
- **API监控**：Fetch和XHR请求监控
- **行为监控**：用户点击、页面路由、PV统计
- **自定义上报**：支持业务自定义埋点
- **多端支持**：浏览器端、微信小程序端

## 架构设计

### 1. Monorepo 架构

项目采用monorepo管理方式，具有以下优势：

- **模块化开发**：每个功能模块独立开发、测试、发布
- **代码复用**：核心功能抽象为基类，各端继承实现
- **依赖管理**：统一管理依赖关系，避免重复安装
- **开发效率**：统一的构建、测试、发布流程

### 2. 包结构

```
packages/
├── core/          # 核心模块（基础抽象类）
├── browser/       # 浏览器端实现
├── vue/           # Vue插件
├── wx-mini/       # 微信小程序端实现
├── types/         # TypeScript类型定义
├── enums/         # 枚举常量
└── utils/         # 工具函数
```

### 3. 设计原则

#### 3.1 主次关系
- **主要目录**：不同端（浏览器、微信小程序）
- **次要目录**：功能插件（错误监控、性能监控、行为监控）
- **辅助目录**：工具库、类型库、枚举库

#### 3.2 继承关系
- **核心库**：BaseClient 抽象基类，定义通用接口
- **端实现**：各端继承基类，实现平台特定功能
- **插件系统**：采用发布-订阅模式，支持插件化扩展

### 4. 技术架构

#### 4.1 核心架构图

```
         ┌─────────────────┐
         │   Application   │
         └─────────────────┘
                  │
         ┌─────────────────┐
         │   Browser SDK   │
         └─────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
┌───▼───┐    ┌────▼────┐    ┌───▼───┐
│Plugins│    │  Core   │    │Utils │
└───────┘    └─────────┘    └───────┘
                  │
         ┌─────────────────┐
         │   Subscribe     │
         └─────────────────┘
```

#### 4.2 数据流向

1. **监控数据收集**：插件监听各种事件（错误、性能、行为）
2. **数据转换**：将原始数据转换为统一格式
3. **数据过滤**：根据配置过滤不需要的数据
4. **数据上报**：通过统一的上报机制发送到服务端

### 5. 插件系统

#### 5.1 插件架构
采用发布-订阅观察者模式，支持：
- 插件按需加载
- 插件独立开发
- 插件配置化启用/禁用

#### 5.2 插件类型
- **错误监控插件**：JS错误、资源错误、Promise错误
- **性能监控插件**：各类性能指标监控
- **行为监控插件**：用户行为数据收集
- **API监控插件**：HTTP请求监控

### 6. 数据上报

#### 6.1 上报策略
- **批量上报**：达到缓存阈值时批量发送
- **实时上报**：错误类数据立即上报
- **页面卸载上报**：页面关闭前上报剩余数据

#### 6.2 上报方式
- **Beacon API**：主要上报方式（不阻塞页面）
- **XHR/Fetch**：备用上报方式
- **Image**：兜底上报方式

### 7. 配置化设计

支持细粒度的功能开关：
- 可按功能模块启用/禁用
- 可按具体插件启用/禁用
- 支持采样率配置
- 支持自定义钩子函数

### 8. 构建与发布

#### 8.1 构建系统
- **Rollup**：专门用于库文件打包
- **多格式输出**：CJS、ESM、IIFE三种格式
- **环境区分**：开发版和生产版

#### 8.2 发布系统
- **独立发布**：每个包可独立发布
- **版本管理**：统一版本号管理
- **体积监控**：发布前进行包体积检测

## 总结

Quantum Monitor 通过合理的架构设计实现了：
- **高可扩展性**：插件化架构支持功能扩展
- **高可维护性**：模块化设计降低维护成本
- **高性能**：异步上报不阻塞主线程
- **高兼容性**：多端支持满足不同场景需求 